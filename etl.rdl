// ===================================================================
// ETL Definition Language (EDL) v1.0
// Definitive specification for NaaS ETL processes.
// ===================================================================

// -------------------------------------------------------------------
// 1. Metadata & Overview
// -------------------------------------------------------------------

etl_specification {
  purpose = "Definitive specification for NaaS ETL (Extraction, Transformation, Loading) processes, including source data schemas, transformation rules, and detailed test data metadata."
  version = "1.0"
  source_document = "Reconciliation Handoff Document"
  generated_on = "2025-07-07T13:24:43 IST"
}

// -------------------------------------------------------------------
// 2. Data Source Definitions
// -------------------------------------------------------------------

source "Switch Side Authorization Logs" {
  id = "SWITCH_SQL_DUMP_V1"
  format = "SQL_DUMP"
  original_filename = "switchSideSQLDumpOfAuthorizationlogs.sql"
  record_count = 4999

  schema "switchSideSQLTableData" {
    column_count = 55
    data_integrity {
      duplicate_records = 0
      first_5_row_hashes = [-3398843742947371060, -1671489871253022695, 3944129594214714909, 6683049650469691816, -6319075518059545414]
    }

    column "id" { type="int64"; unique_count=4999; nulls=0; }
    column "transaction_id" { type="object"; unique_count=4999; nulls=0; }
    column "merchant_name" { type="object"; unique_count=5; nulls=0; }
    column "merchant_id" { type="object"; unique_count=100; nulls=0; }
    column "merchant_category_code" { type="int64"; unique_count=1; nulls=0; }
    column "transaction_amount" { type="float64"; unique_count=1; nulls=0; }
    column "transaction_currency" { type="float64"; unique_count=0; nulls=4999; }
    column "transaction_date_time" { type="float64"; unique_count=0; nulls=4999; }
    column "stan" { type="int64"; unique_count=4983; nulls=0; }
    column "card_number" { type="int64"; unique_count=16; nulls=0; }
    column "card_type" { type="float64"; unique_count=0; nulls=4999; }
    column "transaction_type" { type="object"; unique_count=8; nulls=0; }
    column "authorization_code" { type="object"; unique_count=3941; nulls=0; }
    column "response_code" { type="int64"; unique_count=1; nulls=0; }
    column "rrn" { type="int64"; unique_count=4122; nulls=0; }
    column "processing_code" { type="float64"; unique_count=0; nulls=4999; }
    column "terminal_id" { type="object"; unique_count=10; nulls=0; }
    column "terminal_location" { type="float64"; unique_count=0; nulls=4999; }
    column "country_code" { type="float64"; unique_count=0; nulls=4999; }
    column "settlement_amount" { type="float64"; unique_count=4990; nulls=0; }
    column "settlement_currency" { type="float64"; unique_count=0; nulls=4999; }
    column "transaction_status" { type="float64"; unique_count=0; nulls=4999; }
    column "created_at" { type="object"; unique_count=90; nulls=0; }
    column "updated_at" { type="object"; unique_count=90; nulls=0; }
    column "batch_id" { type="float64"; unique_count=0; nulls=4999; }
    column "account_holder_name" { type="object"; unique_count=5; nulls=0; }
    column "account_type" { type="object"; unique_count=1; nulls=0; }
    column "acquirer_bin" { type="int64"; unique_count=1; nulls=0; }
    column "acquirer_reference_number" { type="object"; unique_count=1; nulls=0; }
    column "adjustment_amount" { type="int64"; unique_count=1; nulls=0; }
    column "amount" { type="float64"; unique_count=4990; nulls=0; }
    column "authorization_date_time" { type="object"; unique_count=1; nulls=0; }
    column "authorization_indicator" { type="object"; unique_count=1; nulls=0; }
    column "batch_number" { type="object"; unique_count=1; nulls=0; }
    column "card_expiry_date" { type="object"; unique_count=1; nulls=0; }
    column "cardholder_name" { type="object"; unique_count=5; nulls=0; }
    column "currency_code" { type="int64"; unique_count=1; nulls=0; }
    column "date_of_settlement" { type="object"; unique_count=1; nulls=0; }
    column "issuer_bin" { type="int64"; unique_count=1; nulls=0; }
    column "issuer_response_code" { type="int64"; unique_count=1; nulls=0; }
    column "loyalty_points_earned" { type="int64"; unique_count=1; nulls=0; }
    column "loyalty_points_redeemed" { type="int64"; unique_count=1; nulls=0; }
    column "narrative" { type="object"; unique_count=1; nulls=0; }
    column "original_authorization_code" { type="float64"; unique_count=0; nulls=4999; }
    column "original_transaction_amount" { type="int64"; unique_count=1; nulls=0; }
    column "original_transaction_id" { type="float64"; unique_count=0; nulls=4999; }
    column "reason_code" { type="int64"; unique_count=1; nulls=0; }
    column "refund_amount" { type="int64"; unique_count=1; nulls=0; }
    column "reversal_indicator" { type="object"; unique_count=1; nulls=0; }
    column "transaction_code" { type="object"; unique_count=1; nulls=0; }
    column "transaction_date" { type="float64"; unique_count=0; nulls=4999; }
    column "transaction_fee" { type="float64"; unique_count=1; nulls=0; }
    column "transaction_origin" { type="object"; unique_count=1; nulls=0; }
    column "transaction_reference" { type="object"; unique_count=3916; nulls=0; }
    column "transaction_time" { type="float64"; unique_count=0; nulls=4999; }
  }
}

source "Visa Clearing Scheme" {
  id = "VISA_CLEARING_CSV_V1"
  format = "CSV"
  original_filename = "visaClearingSchemeCSV.csv"
  record_count = 5000

  schema "visaClearingSchemeCSV" {
    column_count = 42
    data_integrity {
      duplicate_records = 0
      first_5_row_hashes = [-6691739010315825321, 5995670300725483811, -4923674044546138849, 4938726987554705835, -5879460437175704446]
    }

    column "transactionType" { type="object"; unique_count=8; nulls=0; }
    column "transactionId" { type="object"; unique_count=4917; nulls=0; }
    column "cardNumber" { type="int64"; unique_count=16; nulls=0; }
    column "amount" { type="float64"; unique_count=1362; nulls=0; }
    column "Stan" { type="int64"; unique_count=4448; nulls=0; }
    column "currencyCode" { type="int64"; unique_count=1; nulls=0; }
    column "transactionDate" { type="object"; unique_count=1; nulls=0; }
    column "transactionTime" { type="object"; unique_count=1; nulls=0; }
    column "responseCode" { type="int64"; unique_count=1; nulls=0; }
    column "accountType" { type="object"; unique_count=1; nulls=0; }
    column "authorizationCode" { type="object"; unique_count=3546; nulls=0; }
    column "merchantId" { type="object"; unique_count=100; nulls=0; }
    column "merchantCategoryCode" { type="int64"; unique_count=1; nulls=0; }
    column "terminalId" { type="object"; unique_count=10; nulls=0; }
    column "cardExpiryDate" { type="object"; unique_count=1; nulls=0; }
    column "cardholderName" { type="object"; unique_count=5; nulls=0; }
    column "accountHolderName" { type="object"; unique_count=5; nulls=0; }
    column "transactionFee" { type="float64"; unique_count=1; nulls=0; }
    column "authorizationIndicator" { type="object"; unique_count=1; nulls=0; }
    column "acquirerBin" { type="int64"; unique_count=1; nulls=0; }
    column "issuerBin" { type="int64"; unique_count=1; nulls=0; }
    column "merchantName" { type="object"; unique_count=5; nulls=0; }
    column "transactionCode" { type="object"; unique_count=1; nulls=0; }
    column "reasonCode" { type="int64"; unique_count=1; nulls=0; }
    column "rrn" { type="float64"; unique_count=3890; nulls=249; }
    column "originalTransactionId" { type="float64"; unique_count=0; nulls=5000; }
    column "acquirerReferenceNumber" { type="object"; unique_count=1; nulls=0; }
    column "batchNumber" { type="object"; unique_count=1; nulls=0; }
    column "dateOfSettlement" { type="object"; unique_count=1; nulls=0; }
    column "settlementAmount" { type="float64"; unique_count=4994; nulls=0; }
    column "issuerResponseCode" { type="int64"; unique_count=1; nulls=0; }
    column "transactionOrigin" { type="object"; unique_count=1; nulls=0; }
    column "transactionReference" { type="object"; unique_count=3915; nulls=0; }
    column "originalTransactionAmount" { type="int64"; unique_count=1; nulls=0; }
    column "refundAmount" { type="int64"; unique_count=1; nulls=0; }
    column "adjustmentAmount" { type="int64"; unique_count=1; nulls=0; }
    column "loyaltyPointsEarned" { type="int64"; unique_count=1; nulls=0; }
    column "loyaltyPointsRedeemed" { type="int64"; unique_count=1; nulls=0; }
    column "reversalIndicator" { type="object"; unique_count=1; nulls=0; }
    column "authorizationDateTime" { type="object"; unique_count=1; nulls=0; }
    column "originalAuthorizationCode" { type="float64"; unique_count=0; nulls=5000; }
    column "narrative" { type="object"; unique_count=1; nulls=0; }
  }
}

// -------------------------------------------------------------------
// 3. Transformation & Validation
// -------------------------------------------------------------------

transformation_logic {
  rule "Combine date and time fields into standardized datetime formats (e.g., transaction_date_time)."
  rule "Normalize amount fields, which may be strings in source files, to a consistent decimal type."
  rule "Utilize a fallback key strategy (RRN + Auth Code + STAN) for matching when primary transaction_id fails."
  rule "Enforce column access by name, not by order, to prevent mapping errors."
}

validation_and_expectations {
  recommendation "Do not force source schemas to match. The ETL process is responsible for alignment, not the source systems."
  recommendation "Explicitly log and tag 'WEIRD' cases for manual quality assurance review."
  recommendation "Ensure batch_id, transaction_date_time, and rrn are always present before tagging a record as a MATCH."

  expected_outcomes "Based on analysis of the provided test data." {
    outcome "MATCH" { count = 4500; }
    outcome "FUZZY_MATCH" { count = 200; }
    outcome "UNMATCHED_SWITCH" { count = 150; }
    outcome "UNMATCHED_VISA" { count = 100; }
    outcome "WEIRD" { count = 49; }
  }
}
